{% extends "base.html" %}
{% block title %}Ticket · Campus Helpdesk{% endblock %}
{% block content %}
{% set t = ticket %}
<div class="grid lg:grid-cols-3 gap-6">
  <section class="lg:col-span-2 space-y-4">
    <div class="bg-white rounded-2xl shadow-soft p-6">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h1 class="text-xl font-semibold">#{{ t.id }} · {{ t.title }}</h1>
          <p class="text-sm text-gray-500">Created {{ t.created_at }}</p>
        </div>
        <div class="flex items-center gap-2">
          <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium
            {% if t.priority == 'High' %} bg-red-100 text-red-700
            {% elif t.priority == 'Medium' %} bg-yellow-100 text-yellow-700
            {% else %} bg-blue-100 text-blue-700 {% endif %}">
            {{ t.priority or 'Low' }}
          </span>
          <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium
            {% if t.status == 'open' %} bg-green-100 text-green-700
            {% elif t.status == 'in_progress' %} bg-amber-100 text-amber-700
            {% elif t.status == 'closed' %} bg-gray-200 text-gray-700
            {% else %} bg-blue-100 text-blue-700 {% endif %}">
            {{ t.status or 'open' }}
          </span>
        </div>
      </div>
      <div class="prose max-w-none mt-4">
        <p class="whitespace-pre-line">{{ t.description }}</p>
      </div>
    </div>

    <!-- Attachments -->
    {% if attachments %}
    <div class="bg-white rounded-2xl shadow-soft p-6">
      <h2 class="text-sm font-semibold mb-3">Attachments</h2>
      <ul class="space-y-2 border-t border-gray-100 pt-3">
        {% for att in attachments %}
        <li class="text-sm">
          <a href="{{ url_for('download_file', filename=att.stored_filename) }}" class="text-brand-700 hover:underline flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
            {{ att.original_filename }}
          </a>
        </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}

    <div class="bg-white rounded-2xl shadow-soft p-6">
      <h2 class="text-sm font-semibold mb-3">Comments</h2>
      <div class="space-y-4">
        {% for c in comments or [] %}
        <div class="border border-gray-100 rounded-xl p-4">
          <div class="flex items-center justify-between text-xs text-gray-500 mb-2">
            <span>@{{ c.username }}</span>
            <span>{{ c.created_at }}</span>
          </div>
          <p class="text-sm whitespace-pre-line">{{ c.content }}</p>
        </div>
        {% else %}
        <p class="text-sm text-gray-500">No comments yet.</p>
        {% endfor %}
      </div>

      <form method="POST" action="{{ url_for('comment_add', ticket_id=t.id) }}" class="mt-4 space-y-3">
        <textarea name="content" rows="3" required class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-500" placeholder="Write a comment..."></textarea>
        <div class="flex justify-end">
          <button class="bg-brand-600 hover:bg-brand-700 text-white rounded-lg px-3 py-2 text-sm">Add Comment</button>
        </div>
      </form>
    </div>
  </section>

  <aside class="space-y-4">
    <div class="bg-white rounded-2xl shadow-soft p-6 text-sm">
      <h3 class="font-semibold mb-3">Ticket Info</h3>
      <div class="space-y-2">
        <div class="flex justify-between"><span class="text-gray-500">Priority:</span><span>{{ t.priority or '-' }}</span></div>
        <div class="flex justify-between"><span class="text-gray-500">Category:</span><span>{{ t.category or '-' }}</span></div>
        <div class="flex justify-between"><span class="text-gray-500">Assigned to:</span><span>{{ t.assigned_to or '—' }}</span></div>
      </div>
    </div>

    {% if role in ['admin','agent'] %}
    <div class="bg-white rounded-2xl shadow-soft p-6 text-sm">
      <h3 class="font-semibold mb-3">Agent Actions</h3>
      <form method="POST" action="{{ url_for('ticket_update', ticket_id=t.id) }}" class="space-y-3">
        <div>
          <label class="block text-xs font-medium mb-1">Status</label>
          <select name="status" class="w-full rounded-lg border border-gray-300 px-3 py-2">
            <option value="">— keep —</option>
            <option value="open">open</option>
            <option value="in_progress">in_progress</option>
            <option value="closed">closed</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium mb-1">Priority</label>
          <select name="priority" class="w-full rounded-lg border border-gray-300 px-3 py-2">
            <option value="">— keep —</option>
            <option>Low</option>
            <option>Medium</option>
            <option>High</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium mb-1">Assign to (user id)</label>
          <input name="assign_to" class="w-full rounded-lg border border-gray-300 px-3 py-2" placeholder="e.g., 2" />
        </div>
        <button class="bg-gray-900 hover:bg-black text-white rounded-lg px-3 py-2">Update</button>
      </form>
    </div>
    {% endif %}
  </aside>
</div>
{% endblock %}